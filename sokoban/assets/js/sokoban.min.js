function levelObject(e){for(this.cratesToPlace=0,this.levelMapOrig=new Array,this.levelHeight=e.length,i=0;i<this.levelHeight;i++)for(this.levelMapOrig[i]=new Array,this.levelWidth=e[i].length,j=0;j<this.levelWidth;j++)"@"==e[i].charAt(j)?this.levelMapOrig[i][j]=1:"o"==e[i].charAt(j)?this.levelMapOrig[i][j]=2:"x"==e[i].charAt(j)?(this.levelMapOrig[i][j]=3,this.cratesToPlace+=1):"^"==e[i].charAt(j)?(this.levelMapOrig[i][j]=4,this.playerStartX=j,this.playerStartY=i,this.playerStartDir=0):"v"==e[i].charAt(j)?(this.levelMapOrig[i][j]=4,this.playerStartX=j,this.playerStartY=i,this.playerStartDir=3):"<"==e[i].charAt(j)?(this.levelMapOrig[i][j]=4,this.playerStartX=j,this.playerStartY=i,this.playerStartDir=1):">"==e[i].charAt(j)?(this.levelMapOrig[i][j]=4,this.playerStartX=j,this.playerStartY=i,this.playerStartDir=2):this.levelMapOrig[i][j]=0}function playerObject(){this.x=0,this.y=0,this.startX=0,this.startY=0,this.startDir=0,this.d=3,this.ani=0,this.animate=function(){this.ani++,this.ani>3&&(this.ani=0)},this.setStartPos=function(e,t,a){this.startX=e,this.startY=t,this.startDir=a},this.setPos=function(e,t,a){this.x=e,this.y=t,this.d=a},this.reset=function(){this.setPos(this.startX,this.startY,this.startDir)},this.moveUp=function(){handleMove(Direction.Up)&&(this.y-=1,moves+=1),this.d=Direction.Up,this.animate()},this.moveDown=function(){handleMove(Direction.Down)&&(this.y+=1,moves+=1),this.d=Direction.Down,this.animate()},this.moveLeft=function(){handleMove(Direction.Left)&&(this.x-=1,moves+=1),this.d=Direction.Left,this.animate()},this.moveRight=function(){handleMove(Direction.Right)&&(this.x+=1,moves+=1),this.d=Direction.Right,this.animate()}}function stepObject(e,t,a,l,i,r,n){this.playerPrevX=e,this.playerPrevY=t,this.playerPrevDir=a,this.crateMoved=l,this.crateMoved&&(this.crateX=i,this.crateY=r,this.cratePushDir=n)}function addStep(e,t,a,l,i,r,n){step.length===maxSteps&&step.shift(),step.push(new stepObject(e,t,a,l,i,r,n))}function undoMove(){if(step.length>0){var e=step.pop();if(player.setPos(e.playerPrevX,e.playerPrevY,e.playerPrevDir),e.crateMoved)switch(e.cratePushDir){case Direction.Up:levelMap[e.crateY][e.crateX]=Tile.Empty,levelMap[e.crateY+1][e.crateX]=Tile.Crate;break;case Direction.Left:levelMap[e.crateY][e.crateX]=Tile.Empty,levelMap[e.crateY][e.crateX+1]=Tile.Crate;break;case Direction.Right:levelMap[e.crateY][e.crateX]=Tile.Empty,levelMap[e.crateY][e.crateX-1]=Tile.Crate;break;case Direction.Down:levelMap[e.crateY][e.crateX]=Tile.Empty,levelMap[e.crateY-1][e.crateX]=Tile.Crate}drawField()}else console.log("No more moves to undo!")}function tileFromImage(e){this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.canvas.width=32,this.canvas.height=32,this.ctx.drawImage(e,0,0,32,32)}function tileFromSubImage(e,t,a,l,i){this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.canvas.width=32,this.canvas.height=32,this.ctx.drawImage(e,t,a,l,i,0,0,32,32)}function loadPlayerTiles(){playerTileSet=new Image,playerTileSet.src="my_sprites_charset.png",playerTileSet.onload=function(){for(context.drawImage(playerTileSet,0,0),i=0;i<4;i++)for(playerTiles[i]=new Array,j=0;j<4;j++)playerTiles[i].push(new tileFromSubImage(playerTileSet,32*j,32*i,32,32));resetLevel()}}function mapTilesLoaded(e){mapTiles=e,loadPlayerTiles()}function bordersWallsOnly(e,t,a,l,i){for(yDif=-1;yDif<=1;yDif++)for(xDif=-1;xDif<=1;xDif++)if((0!==yDif||0!==xDif)&&(newX=t+xDif,newY=a+yDif,newX>=0&&newX<=l&&newY>=0&&newY<=i&&e[newY][newX]!=Tile.Wall&&e[newY][newX]!=Tile.None))return!1;return!0}function removeWalls(e){for(xMax=level[currentLevel].levelWidth-1,yMax=level[currentLevel].levelHeight-1,xMin=0,yMin=0,i=0;i<=yMax;i++)for(j=0;j<=xMax;j++)bordersWallsOnly(e,j,i,xMax,yMax)&&(e[i][j]=Tile.None)}function resetLevel(){for(levelMap=new Array,i=0;i<level[currentLevel].levelHeight;i++)for(levelMap[i]=new Array,j=0;j<level[currentLevel].levelWidth;j++)switch(level[currentLevel].levelMapOrig[i][j]){case 1:levelMap[i][j]=Tile.Wall;break;case 2:levelMap[i][j]=Tile.Crate;break;case 3:levelMap[i][j]=Tile.Empty;break;case 4:levelMap[i][j]=Tile.Empty;break;default:levelMap[i][j]=Tile.Empty}player.setStartPos(level[currentLevel].playerStartX,level[currentLevel].playerStartY,level[currentLevel].playerStartDir),player.reset(),placedCrates=0,moves=0,pushes=0,step.length=0,updateStats(),resizeInterface(),removeWalls(levelMap),drawField()}function gotoNextLevel(){currentLevel<level.length-1&&(currentLevel+=1,clearCanvas(),resetLevel(),drawField())}function gotoPrevLevel(){currentLevel>0&&(currentLevel-=1,clearCanvas(),resetLevel(),drawField())}function clearCanvas(){var e=document.getElementById("myDrawing"),t=e.getContext("2d");t.clearRect(0,0,e.width,e.height)}function checkField(){for(placedCrates=0,i=0;i<level[currentLevel].levelHeight;i++)for(j=0;j<level[currentLevel].levelWidth;j++)levelMap[i][j]===Tile.Crate&&level[currentLevel].levelMapOrig[i][j]===Tile.Slot&&(placedCrates+=1);placedCrates===level[currentLevel].cratesToPlace&&(currentLevel+1<level.length?gotoNextLevel():console.log("VIDEO SUIVANTE"))}function drawField(){for(i=0;i<level[currentLevel].levelHeight;i++)for(j=0;j<level[currentLevel].levelWidth;j++)drawTile(j,i);context.drawImage(playerTiles[playerDirOffset[player.d]][player.ani].canvas,player.x*tileXSize,player.y*tileYSize)}function drawPartial(){switch(player.d){case Direction.Up:drawTile(player.x,player.y-1),drawTile(player.x,player.y+1);break;case Direction.Left:drawTile(player.x+1,player.y),drawTile(player.x-1,player.y);break;case Direction.Right:drawTile(player.x+1,player.y),drawTile(player.x-1,player.y);break;case Direction.Down:drawTile(player.x,player.y-1),drawTile(player.x,player.y+1)}drawTile(player.x,player.y),context.drawImage(playerTiles[playerDirOffset[player.d]][player.ani].canvas,player.x*tileXSize,player.y*tileYSize)}function drawTile(e,t){switch(levelMap[t][e]){case Tile.None:drawRectangle(e*tileXSize,t*tileYSize,tileXSize,tileYSize,"#00FF00");break;case Tile.Wall:context.drawImage(mapTiles[Tile.Wall].canvas,e*tileXSize,t*tileYSize);break;case Tile.Crate:context.drawImage(mapTiles[Tile.Crate].canvas,e*tileXSize,t*tileYSize);break;default:context.drawImage(mapTiles[Tile.Empty].canvas,e*tileXSize,t*tileYSize),level[currentLevel].levelMapOrig[t][e]===Tile.Slot&&drawCircle(e*tileXSize+16,t*tileYSize+16,7,"#FF0000"),level[currentLevel].levelMapOrig[t][e]===Tile.Start&&drawCircle(e*tileXSize+16,t*tileYSize+16,7,"#00FF00")}}function handleMove(e){var t=0,a=0;switch(e){case Direction.Up:a=-1;break;case Direction.Left:t=-1;break;case Direction.Right:t=1;break;case Direction.Down:a=1}if(levelMap[player.y+a][player.x+t]!=Tile.Wall){if(levelMap[player.y+a][player.x+t]!==Tile.Crate)return addStep(player.x,player.y,player.d,!1,0,0,0),!0;if(levelMap[player.y+2*a][player.x+2*t]===Tile.Empty)return levelMap[player.y+a][player.x+t]=Tile.Empty,levelMap[player.y+2*a][player.x+2*t]=Tile.Crate,addStep(player.x,player.y,player.d,!0,player.x+2*t,player.y+2*a,e),pushes+=1,!0}return!1}function drawCircle(e,t,a,l){context.fillStyle=l,context.beginPath(),context.arc(e,t,a,0,2*Math.PI,!0),context.closePath(),context.fill()}function drawRectangle(e,t,a,l,i){context.fillStyle=i,context.fillRect(e,t,a,l)}function updateStats(){var e=document.getElementById("levelInfo");e.innerHTML="Level: "+(currentLevel+1),e=document.getElementById("stepsInfo"),e.innerHTML="Moves: "+moves,e=document.getElementById("pushesInfo"),e.innerHTML="Pushes: "+pushes,e=document.getElementById("cratesInfo"),e.innerHTML="Crates in place: "+placedCrates+" / "+level[currentLevel].cratesToPlace}function resizeInterface(){canvas.width=level[currentLevel].levelWidth*tileXSize,canvas.height=level[currentLevel].levelHeight*tileYSize;var e=document.getElementById("scoreBoard"),t=document.getElementById("levelControl");e.style.width=""+canvas.width+"px",t.style.width=""+canvas.width+"px";var a=document.getElementById("help");a.style.top=canvas.offsetTop+10+"px",a.style.left=canvas.offsetLeft+10+"px",a.style.width=canvas.width-30+"px",a.style.height=canvas.height-30+"px"}function showHelp(){var e=document.getElementById("help");e.style.display="block"}function hideHelp(){var e=document.getElementById("help");e.style.display="none"}var level=new Array,levelDataLine=new Array;levelDataLine[0]="@@@@@@@@@@@@@@@@@",levelDataLine[1]="@  @  @  @  @ x @",levelDataLine[2]="@> o  @     @   @",levelDataLine[3]="@  @     @      @",levelDataLine[4]="@  @  @  @  @   @",levelDataLine[5]="@@@@@@@@@@@@@@@@@",level[0]=new levelObject(levelDataLine),levelDataLine=new Array,levelDataLine[0]="@@@@@@@@@@@@@@@@@",levelDataLine[1]="@@@@@@@@@     <@@",levelDataLine[2]="@@@@@@@@@ o@  @@@",levelDataLine[3]="@@@@@@@@@     @@@",levelDataLine[4]="@@@@@@@@@@    @@@",levelDataLine[5]="@@@@@@@@@   @ @@@",levelDataLine[6]="@x     @@   o   @",levelDataLine[7]="@@              @",levelDataLine[8]="@x     @@@@@@@@@@",levelDataLine[9]="@@@@@@@@@@@@@@@@@",level[1]=new levelObject(levelDataLine),levelDataLine=new Array,levelDataLine[0]="@@@@@@@@@@@@@@@@@",levelDataLine[1]="@@@@@@   @@@@@@@@",levelDataLine[2]="@@@@@@ @>o @@@@@@",levelDataLine[3]="@@@@@@x  @ @@@@@@",levelDataLine[4]="@@@@@@ ox  @@@@@@",levelDataLine[5]="@@@@@@@  @@@@@@@@",levelDataLine[6]="@@@@@@@  @@@@@@@@",levelDataLine[7]="@@@@@@@@@@@@@@@@@",level[2]=new levelObject(levelDataLine);var Direction={Up:0,Left:1,Right:2,Down:3},Tile={None:-1,Empty:0,Wall:1,Crate:2,Slot:3,Start:4},canvas,context,playerTileSet,floorTile,wallTile,crateTile;playerDirOffset=new Array(3,1,2,0),playerAniOffset=new Array(0,1,2,3);var mapTiles=new Array,playerTiles=new Array,currentLevel=0,levelMap,placedCrates,moves=0,pushes=0,tileXSize=32,tileYSize=32,step=new Array,maxSteps=500,player=new playerObject,ImageLoader={imgArray:[],toLoad:0,tileArray:[],callback:0,init:function(e,t){this.imgArray=e,this.toLoad=this.imgArray.length,this.callback=t;for(i in this.imgArray)this.tileArray[i]=0},startLoading:function(){for(i in this.imgArray)img=new Image,img.src=this.imgArray[i],img.imgIndex=i,img.onload=function(){ImageLoader.finishedLoading(this)}},finishedLoading:function(e){this.toLoad-=1,this.tileArray[e.imgIndex]=new tileFromImage(e),this.toLoad<=0&&this.callback(this.tileArray)}};window.onload=function(){canvas=document.getElementById("myDrawing"),context=canvas.getContext("2d"),ImageLoader.init(new Array("../img/textures/ground.png","../img/textures/wall.png","../img/textures/stone.png"),mapTilesLoaded),ImageLoader.startLoading()},document.onkeydown=function(e){var t=e;switch(t.keyCode){case 38:player.moveUp();break;case 37:player.moveLeft();break;case 39:player.moveRight();break;case 40:player.moveDown();break;case 0:114===t.charCode?resetLevel():117===t.charCode&&undoMove()}drawPartial(),checkField(),updateStats()},$(function(){$("#arrow-top").on("click",function(){var e=$.Event("keydown",{keyCode:38});$("body").trigger(e)}),$("#arrow-bottom").on("click",function(){var e=$.Event("keydown",{keyCode:40});$("body").trigger(e)}),$("#arrow-left").on("click",function(){var e=$.Event("keydown",{keyCode:37});$("body").trigger(e)}),$("#arrow-right").on("click",function(){var e=$.Event("keydown",{keyCode:39});$("body").trigger(e)})});