function levelObject(e){for(this.cratesToPlace=0,this.levelMapOrig=new Array,this.levelHeight=e.length,i=0;i<this.levelHeight;i++)for(this.levelMapOrig[i]=new Array,this.levelWidth=e[i].length,j=0;j<this.levelWidth;j++)"@"==e[i].charAt(j)?this.levelMapOrig[i][j]=1:"o"==e[i].charAt(j)?this.levelMapOrig[i][j]=2:"x"==e[i].charAt(j)?(this.levelMapOrig[i][j]=3,this.cratesToPlace+=1):"^"==e[i].charAt(j)?(this.levelMapOrig[i][j]=4,this.playerStartX=j,this.playerStartY=i,this.playerStartDir=0):"v"==e[i].charAt(j)?(this.levelMapOrig[i][j]=4,this.playerStartX=j,this.playerStartY=i,this.playerStartDir=3):"<"==e[i].charAt(j)?(this.levelMapOrig[i][j]=4,this.playerStartX=j,this.playerStartY=i,this.playerStartDir=1):">"==e[i].charAt(j)?(this.levelMapOrig[i][j]=4,this.playerStartX=j,this.playerStartY=i,this.playerStartDir=2):this.levelMapOrig[i][j]=0}var level=new Array,levelDataLine=new Array;levelDataLine[0]="@@@@@@@@@@@@@@@@@",levelDataLine[1]="@  @  @  @  @ x @",levelDataLine[2]="@> o  @     @   @",levelDataLine[3]="@  @     @      @",levelDataLine[4]="@  @  @  @  @   @",levelDataLine[5]="@@@@@@@@@@@@@@@@@",level[0]=new levelObject(levelDataLine),levelDataLine=new Array,levelDataLine[0]="@@@@@@@@@@@@@@@@@",levelDataLine[1]="@@@@@@@@@     <@@",levelDataLine[2]="@@@@@@@@@ o@  @@@",levelDataLine[3]="@@@@@@@@@     @@@",levelDataLine[4]="@@@@@@@@@@    @@@",levelDataLine[5]="@@@@@@@@@   @ @@@",levelDataLine[6]="@x     @@   o   @",levelDataLine[7]="@@              @",levelDataLine[8]="@x     @@@@@@@@@@",levelDataLine[9]="@@@@@@@@@@@@@@@@@",level[1]=new levelObject(levelDataLine),levelDataLine=new Array,levelDataLine[0]="@@@@@@@@@@@@@@@@@",levelDataLine[1]="@@@@@@   @@@@@@@@",levelDataLine[2]="@@@@@@ @>o @@@@@@",levelDataLine[3]="@@@@@@x  @ @@@@@@",levelDataLine[4]="@@@@@@ ox  @@@@@@",levelDataLine[5]="@@@@@@@  @@@@@@@@",levelDataLine[6]="@@@@@@@  @@@@@@@@",levelDataLine[7]="@@@@@@@@@@@@@@@@@",level[2]=new levelObject(levelDataLine),window.currentPart=function(){function e(){this.x=0,this.y=0,this.startX=0,this.startY=0,this.startDir=0,this.d=3,this.ani=0,this.animate=function(){this.ani++,this.ani>3&&(this.ani=0)},this.setStartPos=function(e,t,i){this.startX=e,this.startY=t,this.startDir=i},this.setPos=function(e,t,i){this.x=e,this.y=t,this.d=i},this.reset=function(){this.setPos(this.startX,this.startY,this.startDir)},this.moveUp=function(){m(k.Up)&&(this.y-=1,P+=1),this.d=k.Up,this.animate()},this.moveDown=function(){m(k.Down)&&(this.y+=1,P+=1),this.d=k.Down,this.animate()},this.moveLeft=function(){m(k.Left)&&(this.x-=1,P+=1),this.d=k.Left,this.animate()},this.moveRight=function(){m(k.Right)&&(this.x+=1,P+=1),this.d=k.Right,this.animate()}}function t(e,t,i,a,r,n,l){this.playerPrevX=e,this.playerPrevY=t,this.playerPrevDir=i,this.crateMoved=a,this.crateMoved&&(this.crateX=r,this.crateY=n,this.cratePushDir=l)}function a(e,i,a,r,n,l,s){U.length===_&&U.shift(),U.push(new t(e,i,a,r,n,l,s))}function r(){if(U.length>0){var e=U.pop();if(H.setPos(e.playerPrevX,e.playerPrevY,e.playerPrevDir),e.crateMoved)switch(e.cratePushDir){case k.Up:X[e.crateY][e.crateX]=A.Empty,X[e.crateY+1][e.crateX]=A.Crate;break;case k.Left:X[e.crateY][e.crateX]=A.Empty,X[e.crateY][e.crateX+1]=A.Crate;break;case k.Right:X[e.crateY][e.crateX]=A.Empty,X[e.crateY][e.crateX-1]=A.Crate;break;case k.Down:X[e.crateY][e.crateX]=A.Empty,X[e.crateY-1][e.crateX]=A.Crate}d()}else console.log("No more moves to undo!")}function n(e){this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.canvas.width=32,this.canvas.height=32,this.ctx.drawImage(e,0,0,32,32)}function l(e,t,i,a,r){this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.canvas.width=32,this.canvas.height=32,this.ctx.drawImage(e,t,i,a,r,0,0,32,32)}function s(){S=new Image,S.src="./sokoban/assets/img/my_sprites_charset.png",S.onload=function(){for(L.drawImage(S,0,0),i=0;i<4;i++)for(C[i]=new Array,j=0;j<4;j++)C[i].push(new l(S,32*j,32*i,32,32));v()}}function o(e){O=e,s()}function c(e,t,i,a,r){for(yDif=-1;yDif<=1;yDif++)for(xDif=-1;xDif<=1;xDif++)if((0!==yDif||0!==xDif)&&(newX=t+xDif,newY=i+yDif,newX>=0&&newX<=a&&newY>=0&&newY<=r&&e[newY][newX]!=A.Wall&&e[newY][newX]!=A.None))return!1;return!0}function h(e){for(xMax=level[E].levelWidth-1,yMax=level[E].levelHeight-1,xMin=0,yMin=0,i=0;i<=yMax;i++)for(j=0;j<=xMax;j++)c(e,j,i,xMax,yMax)&&(e[i][j]=A.None)}function v(){for(X=new Array,i=0;i<level[E].levelHeight;i++)for(X[i]=new Array,j=0;j<level[E].levelWidth;j++)switch(level[E].levelMapOrig[i][j]){case 1:X[i][j]=A.Wall;break;case 2:X[i][j]=A.Crate;break;case 3:X[i][j]=A.Empty;break;case 4:X[i][j]=A.Empty;break;default:X[i][j]=A.Empty}H.setStartPos(level[E].playerStartX,level[E].playerStartY,level[E].playerStartDir),H.reset(),Y=0,P=0,I=0,U.length=0,x(),h(X),d()}function y(){E<level.length-1&&(E+=1,g(),v(),d())}function g(){var e=document.getElementById("myDrawing"),t=e.getContext("2d");t.clearRect(0,0,e.width,e.height)}function f(){for(Y=0,i=0;i<level[E].levelHeight;i++)for(j=0;j<level[E].levelWidth;j++)X[i][j]===A.Crate&&level[E].levelMapOrig[i][j]===A.Slot&&(Y+=1);Y===level[E].cratesToPlace&&(E+1<level.length?y():console.log("VIDEO SUIVANTE"))}function d(){for(i=0;i<level[E].levelHeight;i++)for(j=0;j<level[E].levelWidth;j++)u(j,i);L.drawImage(C[playerDirOffset[H.d]][H.ani].canvas,H.x*W,H.y*R)}function p(){switch(H.d){case k.Up:u(H.x,H.y-1),u(H.x,H.y+1);break;case k.Left:u(H.x+1,H.y),u(H.x-1,H.y);break;case k.Right:u(H.x+1,H.y),u(H.x-1,H.y);break;case k.Down:u(H.x,H.y-1),u(H.x,H.y+1)}u(H.x,H.y),L.drawImage(C[playerDirOffset[H.d]][H.ani].canvas,H.x*W,H.y*R)}function u(e,t){switch(X[t][e]){case A.None:D(e*W,t*R,W,R,"transparent");break;case A.Wall:L.drawImage(O[A.Wall].canvas,e*W,t*R);break;case A.Crate:L.drawImage(O[A.Crate].canvas,e*W,t*R);break;default:L.drawImage(O[A.Empty].canvas,e*W,t*R),level[E].levelMapOrig[t][e]===A.Slot&&(w(e*W+16,t*R+16,7,"#000000"),w(e*W+16,t*R+16,3,"#FF0000")),level[E].levelMapOrig[t][e]===A.Start&&w(e*W+16,t*R+16,7,"transparent")}}function m(e){var t=0,i=0;switch(e){case k.Up:i=-1;break;case k.Left:t=-1;break;case k.Right:t=1;break;case k.Down:i=1}if(X[H.y+i][H.x+t]!=A.Wall){if(X[H.y+i][H.x+t]!==A.Crate)return a(H.x,H.y,H.d,!1,0,0,0),!0;if(X[H.y+2*i][H.x+2*t]===A.Empty)return X[H.y+i][H.x+t]=A.Empty,X[H.y+2*i][H.x+2*t]=A.Crate,a(H.x,H.y,H.d,!0,H.x+2*t,H.y+2*i,e),I+=1,!0}return!1}function w(e,t,i,a){L.fillStyle=a,L.beginPath(),L.arc(e,t,i,0,2*Math.PI,!0),L.closePath(),L.fill()}function D(e,t,i,a,r){L.fillStyle=r,L.fillRect(e,t,i,a)}function x(){b.width=level[E].levelWidth*W,b.height=level[E].levelHeight*R}var b,L,k={Up:0,Left:1,Right:2,Down:3},A={None:-1,Empty:0,Wall:1,Crate:2,Slot:3,Start:4};b=document.getElementById("myDrawing"),L=b.getContext("2d");var M={imgArray:[],toLoad:0,tileArray:[],callback:0,init:function(e,t){this.imgArray=e,this.toLoad=this.imgArray.length,this.callback=t;for(i in this.imgArray)this.tileArray[i]=0},startLoading:function(){for(i in this.imgArray)img=new Image,img.src=this.imgArray[i],img.imgIndex=i,img.onload=function(){M.finishedLoading(this)}},finishedLoading:function(e){this.toLoad-=1,this.tileArray[e.imgIndex]=new n(e),this.toLoad<=0&&this.callback(this.tileArray)}};M.init(new Array("./sokoban/assets/img/textures/ground.png","./sokoban/assets/img/textures/wall.png","./sokoban/assets/img/textures/stone.png"),o),M.startLoading();var S;playerDirOffset=new Array(3,1,2,0),playerAniOffset=new Array(0,1,2,3);var X,Y,O=new Array,C=new Array,E=0,P=0,I=0,W=32,R=32,U=new Array,_=500,H=new e;document.onkeydown=function(e){var t=e;switch(t.keyCode){case 38:H.moveUp();break;case 37:H.moveLeft();break;case 39:H.moveRight();break;case 40:H.moveDown();break;case 0:114===t.charCode?v():117===t.charCode&&r()}p(),f()},$(function(){$("#arrow-top").on("click",function(){var e=$.Event("keydown",{keyCode:38});$("body").trigger(e)}),$("#arrow-bottom").on("click",function(){var e=$.Event("keydown",{keyCode:40});$("body").trigger(e)}),$("#arrow-left").on("click",function(){var e=$.Event("keydown",{keyCode:37});$("body").trigger(e)}),$("#arrow-right").on("click",function(){var e=$.Event("keydown",{keyCode:39});$("body").trigger(e)}),$("#btn_game_reload").on("click",function(){v()}),$("#btn_game_cancel").on("click",function(){r()});var e="Aide le panda!",t="Pousse les pierres sur leurs emplacements pour libérer ton amis le panda.";$("#instructions h3").text(e),$("#instructions p.description").text(t);var i='<img src="./assets/img/arrowkeys.png" class="img-responsive"/>',a="Déplacements";$("#instructions p.inst_controls").append("<br/>"+i),$("#instructions p.inst_controls").append("<br/><br/>"+a),$.fn.nodoubletapzoom=function(){$(this).bind("touchstart",function(e){var t=e.timeStamp,i=$(this).data("lastTouch")||t,a=t-i,r=e.originalEvent.touches.length;$(this).data("lastTouch",t),!a||a>500||r>1||(e.preventDefault(),$(e.target).trigger("click"))})},$("body").nodoubletapzoom()})};