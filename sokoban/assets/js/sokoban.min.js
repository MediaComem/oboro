function levelObject(e){for(this.cratesToPlace=0,this.levelMapOrig=new Array,this.levelHeight=e.length,i=0;i<this.levelHeight;i++)for(this.levelMapOrig[i]=new Array,this.levelWidth=e[i].length,j=0;j<this.levelWidth;j++)"@"==e[i].charAt(j)?this.levelMapOrig[i][j]=1:"o"==e[i].charAt(j)?this.levelMapOrig[i][j]=2:"x"==e[i].charAt(j)?(this.levelMapOrig[i][j]=3,this.cratesToPlace+=1):"^"==e[i].charAt(j)?(this.levelMapOrig[i][j]=4,this.playerStartX=j,this.playerStartY=i,this.playerStartDir=0):"v"==e[i].charAt(j)?(this.levelMapOrig[i][j]=4,this.playerStartX=j,this.playerStartY=i,this.playerStartDir=3):"<"==e[i].charAt(j)?(this.levelMapOrig[i][j]=4,this.playerStartX=j,this.playerStartY=i,this.playerStartDir=1):">"==e[i].charAt(j)?(this.levelMapOrig[i][j]=4,this.playerStartX=j,this.playerStartY=i,this.playerStartDir=2):this.levelMapOrig[i][j]=0}var level=new Array,levelDataLine=new Array;levelDataLine[0]="@@@@@@@@@@@@@@@@@",levelDataLine[1]="@  @  @  @  @ x @",levelDataLine[2]="@> o  @     @   @",levelDataLine[3]="@  @     @      @",levelDataLine[4]="@  @  @  @  @   @",levelDataLine[5]="@@@@@@@@@@@@@@@@@",level[0]=new levelObject(levelDataLine),levelDataLine=new Array,levelDataLine[0]="@@@@@@@@@@@@@@@@@",levelDataLine[1]="@@@@@@@@@     <@@",levelDataLine[2]="@@@@@@@@@ o@  @@@",levelDataLine[3]="@@@@@@@@@     @@@",levelDataLine[4]="@@@@@@@@@   @ @@@",levelDataLine[5]="@x     @@   o   @",levelDataLine[6]="@@              @",levelDataLine[7]="@x     @@@@@@@@@@",levelDataLine[8]="@@@@@@@@@@@@@@@@@",level[1]=new levelObject(levelDataLine),levelDataLine=new Array,levelDataLine[0]="@@@@@@@@@@@@@@@@@",levelDataLine[1]="@@@@@@   @@@@@@@@",levelDataLine[2]="@@@@@@ @>o @@@@@@",levelDataLine[3]="@@@@@@x  @ @@@@@@",levelDataLine[4]="@@@@@@ ox  @@@@@@",levelDataLine[5]="@@@@@@@  @@@@@@@@",levelDataLine[6]="@@@@@@@  @@@@@@@@",levelDataLine[7]="@@@@@@@@@@@@@@@@@",level[2]=new levelObject(levelDataLine),window.currentPart=function(){function e(e){for(this.cratesToPlace=0,this.levelMapOrig=new Array,this.levelHeight=e.length,i=0;i<this.levelHeight;i++)for(this.levelMapOrig[i]=new Array,this.levelWidth=e[i].length,j=0;j<this.levelWidth;j++)"@"==e[i].charAt(j)?this.levelMapOrig[i][j]=1:"o"==e[i].charAt(j)?this.levelMapOrig[i][j]=2:"x"==e[i].charAt(j)?(this.levelMapOrig[i][j]=3,this.cratesToPlace+=1):"^"==e[i].charAt(j)?(this.levelMapOrig[i][j]=4,this.playerStartX=j,this.playerStartY=i,this.playerStartDir=0):"v"==e[i].charAt(j)?(this.levelMapOrig[i][j]=4,this.playerStartX=j,this.playerStartY=i,this.playerStartDir=3):"<"==e[i].charAt(j)?(this.levelMapOrig[i][j]=4,this.playerStartX=j,this.playerStartY=i,this.playerStartDir=1):">"==e[i].charAt(j)?(this.levelMapOrig[i][j]=4,this.playerStartX=j,this.playerStartY=i,this.playerStartDir=2):this.levelMapOrig[i][j]=0}function t(){this.x=0,this.y=0,this.startX=0,this.startY=0,this.startDir=0,this.d=3,this.ani=0,this.animate=function(){this.ani++,this.ani>3&&(this.ani=0)},this.setStartPos=function(e,t,i){this.startX=e,this.startY=t,this.startDir=i},this.setPos=function(e,t,i){this.x=e,this.y=t,this.d=i},this.reset=function(){this.setPos(this.startX,this.startY,this.startDir)},this.moveUp=function(){m(M.Up)&&(this.y-=1,R+=1),this.d=M.Up,this.animate()},this.moveDown=function(){m(M.Down)&&(this.y+=1,R+=1),this.d=M.Down,this.animate()},this.moveLeft=function(){m(M.Left)&&(this.x-=1,R+=1),this.d=M.Left,this.animate()},this.moveRight=function(){m(M.Right)&&(this.x+=1,R+=1),this.d=M.Right,this.animate()}}function a(e,t,i,a,r,n,l){this.playerPrevX=e,this.playerPrevY=t,this.playerPrevDir=i,this.crateMoved=a,this.crateMoved&&(this.crateX=r,this.crateY=n,this.cratePushDir=l)}function r(e,t,i,r,n,l,s){T.length===N&&T.shift(),T.push(new a(e,t,i,r,n,l,s))}function n(){if(T.length>0){var e=T.pop();if(B.setPos(e.playerPrevX,e.playerPrevY,e.playerPrevDir),e.crateMoved)switch(e.cratePushDir){case M.Up:P[e.crateY][e.crateX]=O.Empty,P[e.crateY+1][e.crateX]=O.Crate;break;case M.Left:P[e.crateY][e.crateX]=O.Empty,P[e.crateY][e.crateX+1]=O.Crate;break;case M.Right:P[e.crateY][e.crateX]=O.Empty,P[e.crateY][e.crateX-1]=O.Crate;break;case M.Down:P[e.crateY][e.crateX]=O.Empty,P[e.crateY-1][e.crateX]=O.Crate}d()}else console.log("No more moves to undo!")}function l(e){this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.canvas.width=32,this.canvas.height=32,this.ctx.drawImage(e,0,0,32,32)}function s(e,t,i,a,r){this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.canvas.width=32,this.canvas.height=32,this.ctx.drawImage(e,t,i,a,r,0,0,32,32)}function h(){Y=new Image,Y.src="./sokoban/assets/img/my_sprites_charset.png",Y.onload=function(){for(S.drawImage(Y,0,0),i=0;i<4;i++)for(I[i]=new Array,j=0;j<4;j++)I[i].push(new s(Y,32*j,32*i,32,32));y()}}function o(e){C=e,h()}function c(e,t,i,a,r){for(yDif=-1;yDif<=1;yDif++)for(xDif=-1;xDif<=1;xDif++)if((0!==yDif||0!==xDif)&&(newX=t+xDif,newY=i+yDif,newX>=0&&newX<=a&&newY>=0&&newY<=r&&e[newY][newX]!=O.Wall&&e[newY][newX]!=O.None))return!1;return!0}function v(e){for(xMax=k[W].levelWidth-1,yMax=k[W].levelHeight-1,xMin=0,yMin=0,i=0;i<=yMax;i++)for(j=0;j<=xMax;j++)c(e,j,i,xMax,yMax)&&(e[i][j]=O.None)}function y(){for(P=new Array,i=0;i<k[W].levelHeight;i++)for(P[i]=new Array,j=0;j<k[W].levelWidth;j++)switch(k[W].levelMapOrig[i][j]){case 1:P[i][j]=O.Wall;break;case 2:P[i][j]=O.Crate;break;case 3:P[i][j]=O.Empty;break;case 4:P[i][j]=O.Empty;break;default:P[i][j]=O.Empty}B.setStartPos(k[W].playerStartX,k[W].playerStartY,k[W].playerStartDir),B.reset(),E=0,R=0,_=0,T.length=0,b(),v(P),d()}function g(){W<k.length-1&&(W+=1,f(),y(),d())}function f(){var e=document.getElementById("myDrawing"),t=e.getContext("2d");t.clearRect(0,0,e.width,e.height)}function p(){for(E=0,i=0;i<k[W].levelHeight;i++)for(j=0;j<k[W].levelWidth;j++)P[i][j]===O.Crate&&k[W].levelMapOrig[i][j]===O.Slot&&(E+=1);E===k[W].cratesToPlace&&(W+1<k.length?g():(console.log("VIDEO SUIVANTE"),window.next()))}function d(){for(i=0;i<k[W].levelHeight;i++)for(j=0;j<k[W].levelWidth;j++)u(j,i);S.drawImage(I[playerDirOffset[B.d]][B.ani].canvas,B.x*H,B.y*U)}function w(){switch(B.d){case M.Up:u(B.x,B.y-1),u(B.x,B.y+1);break;case M.Left:u(B.x+1,B.y),u(B.x-1,B.y);break;case M.Right:u(B.x+1,B.y),u(B.x-1,B.y);break;case M.Down:u(B.x,B.y-1),u(B.x,B.y+1)}u(B.x,B.y),S.drawImage(I[playerDirOffset[B.d]][B.ani].canvas,B.x*H,B.y*U)}function u(e,t){switch(P[t][e]){case O.None:x(e*H,t*U,H,U,"transparent");break;case O.Wall:S.drawImage(C[O.Wall].canvas,e*H,t*U);break;case O.Crate:S.drawImage(C[O.Crate].canvas,e*H,t*U);break;default:S.drawImage(C[O.Empty].canvas,e*H,t*U),k[W].levelMapOrig[t][e]===O.Slot&&(D(e*H+16,t*U+16,7,"#000000"),D(e*H+16,t*U+16,3,"#d2047b")),k[W].levelMapOrig[t][e]===O.Start&&D(e*H+16,t*U+16,7,"transparent")}}function m(e){var t=0,i=0;switch(e){case M.Up:i=-1;break;case M.Left:t=-1;break;case M.Right:t=1;break;case M.Down:i=1}if(P[B.y+i][B.x+t]!=O.Wall){if(P[B.y+i][B.x+t]!==O.Crate)return r(B.x,B.y,B.d,!1,0,0,0),!0;if(P[B.y+2*i][B.x+2*t]===O.Empty)return P[B.y+i][B.x+t]=O.Empty,P[B.y+2*i][B.x+2*t]=O.Crate,r(B.x,B.y,B.d,!0,B.x+2*t,B.y+2*i,e),_+=1,!0}return!1}function D(e,t,i,a){S.fillStyle=a,S.beginPath(),S.arc(e,t,i,0,2*Math.PI,!0),S.closePath(),S.fill()}function x(e,t,i,a,r){S.fillStyle=r,S.fillRect(e,t,i,a)}function b(){L.width=k[W].levelWidth*H,L.height=k[W].levelHeight*U}var k=new Array,A=new Array;A[0]="@@@@@@@@@@@@@@@@@",A[1]="@  @  @  @  @ x @",A[2]="@> o  @     @   @",A[3]="@  @     @      @",A[4]="@  @  @  @  @   @",A[5]="@@@@@@@@@@@@@@@@@",k[0]=new e(A),A=new Array,A[0]="@@@@@@@@@@@@@@@@@",A[1]="@@@@@@@@@     <@@",A[2]="@@@@@@@@@ o@  @@@",A[3]="@@@@@@@@@     @@@",A[4]="@@@@@@@@@   @ @@@",A[5]="@x     @@   o   @",A[6]="@@              @",A[7]="@x     @@@@@@@@@@",A[8]="@@@@@@@@@@@@@@@@@",k[1]=new e(A),A=new Array,A[0]="@@@@@@@@@@@@@@@@@",A[1]="@@@@@@   @@@@@@@@",A[2]="@@@@@@ @>o @@@@@@",A[3]="@@@@@@x  @ @@@@@@",A[4]="@@@@@@ ox  @@@@@@",A[5]="@@@@@@@  @@@@@@@@",A[6]="@@@@@@@  @@@@@@@@",A[7]="@@@@@@@@@@@@@@@@@",k[2]=new e(A),parts.push(new Part("stomachjump"));var L,S,M={Up:0,Left:1,Right:2,Down:3},O={None:-1,Empty:0,Wall:1,Crate:2,Slot:3,Start:4};L=document.getElementById("myDrawing"),S=L.getContext("2d");var X={imgArray:[],toLoad:0,tileArray:[],callback:0,init:function(e,t){this.imgArray=e,this.toLoad=this.imgArray.length,this.callback=t;for(i in this.imgArray)this.tileArray[i]=0},startLoading:function(){for(i in this.imgArray)img=new Image,img.src=this.imgArray[i],img.imgIndex=i,img.onload=function(){X.finishedLoading(this)}},finishedLoading:function(e){this.toLoad-=1,this.tileArray[e.imgIndex]=new l(e),this.toLoad<=0&&this.callback(this.tileArray)}};X.init(new Array("./sokoban/assets/img/textures/ground.png","./sokoban/assets/img/textures/wall.png","./sokoban/assets/img/textures/stone.png"),o),X.startLoading();var Y;playerDirOffset=new Array(3,1,2,0),playerAniOffset=new Array(0,1,2,3);var P,E,C=new Array,I=new Array,W=0,R=0,_=0,H=32,U=32,T=new Array,N=500,B=new t;document.onkeydown=function(e){var t=e;switch(t.keyCode){case 38:B.moveUp();break;case 37:B.moveLeft();break;case 39:B.moveRight();break;case 40:B.moveDown();break;case 78:g();break;case 0:114===t.charCode?y():117===t.charCode&&n()}w(),p()},$(function(){$("#arrow_top").on("click",function(){var e=$.Event("keydown",{keyCode:38});$("body").trigger(e),console.log("fdfddfdkg")}),$("#arrow_bottom").on("click",function(){var e=$.Event("keydown",{keyCode:40});$("body").trigger(e)}),$("#arrow_left").on("click",function(){var e=$.Event("keydown",{keyCode:37});$("body").trigger(e)}),$("#arrow_right").on("click",function(){var e=$.Event("keydown",{keyCode:39});$("body").trigger(e)}),$("#btn_game_reload").on("click",function(){y()}),$("#btn_game_cancel").on("click",function(){n()}),$.fn.nodoubletapzoom=function(){$(this).bind("touchstart",function(e){var t=e.timeStamp,i=$(this).data("lastTouch")||t,a=t-i,r=e.originalEvent.touches.length;$(this).data("lastTouch",t),!a||a>500||r>1||(e.preventDefault(),$(e.target).trigger("click"))})},$("body").nodoubletapzoom(),/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&$("head").append('<link rel="stylesheet" href="./sokoban/mqmobile.css" />')})};