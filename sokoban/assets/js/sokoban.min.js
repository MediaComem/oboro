function levelObject(e){for(this.cratesToPlace=0,this.levelMapOrig=new Array,this.levelHeight=e.length,i=0;i<this.levelHeight;i++)for(this.levelMapOrig[i]=new Array,this.levelWidth=e[i].length,j=0;j<this.levelWidth;j++)"@"==e[i].charAt(j)?this.levelMapOrig[i][j]=1:"o"==e[i].charAt(j)?this.levelMapOrig[i][j]=2:"x"==e[i].charAt(j)?(this.levelMapOrig[i][j]=3,this.cratesToPlace+=1):"^"==e[i].charAt(j)?(this.levelMapOrig[i][j]=4,this.playerStartX=j,this.playerStartY=i,this.playerStartDir=0):"v"==e[i].charAt(j)?(this.levelMapOrig[i][j]=4,this.playerStartX=j,this.playerStartY=i,this.playerStartDir=3):"<"==e[i].charAt(j)?(this.levelMapOrig[i][j]=4,this.playerStartX=j,this.playerStartY=i,this.playerStartDir=1):">"==e[i].charAt(j)?(this.levelMapOrig[i][j]=4,this.playerStartX=j,this.playerStartY=i,this.playerStartDir=2):this.levelMapOrig[i][j]=0}var level=new Array,levelDataLine=new Array;levelDataLine[0]="@@@@@@@@@@@@@@@@@",levelDataLine[1]="@  @  @  @  @ x @",levelDataLine[2]="@> o  @     @   @",levelDataLine[3]="@  @     @      @",levelDataLine[4]="@  @  @  @  @   @",levelDataLine[5]="@@@@@@@@@@@@@@@@@",level[0]=new levelObject(levelDataLine),levelDataLine=new Array,levelDataLine[0]="@@@@@@@@@@@@@@@@@",levelDataLine[1]="@@@@@@@@@     <@@",levelDataLine[2]="@@@@@@@@@ o@  @@@",levelDataLine[3]="@@@@@@@@@     @@@",levelDataLine[4]="@@@@@@@@@@    @@@",levelDataLine[5]="@@@@@@@@@   @ @@@",levelDataLine[6]="@x     @@   o   @",levelDataLine[7]="@@              @",levelDataLine[8]="@x     @@@@@@@@@@",levelDataLine[9]="@@@@@@@@@@@@@@@@@",level[1]=new levelObject(levelDataLine),levelDataLine=new Array,levelDataLine[0]="@@@@@@@@@@@@@@@@@",levelDataLine[1]="@@@@@@   @@@@@@@@",levelDataLine[2]="@@@@@@ @>o @@@@@@",levelDataLine[3]="@@@@@@x  @ @@@@@@",levelDataLine[4]="@@@@@@ ox  @@@@@@",levelDataLine[5]="@@@@@@@  @@@@@@@@",levelDataLine[6]="@@@@@@@  @@@@@@@@",levelDataLine[7]="@@@@@@@@@@@@@@@@@",level[2]=new levelObject(levelDataLine),window.currentPart=function(){function e(){this.x=0,this.y=0,this.startX=0,this.startY=0,this.startDir=0,this.d=3,this.ani=0,this.animate=function(){this.ani++,this.ani>3&&(this.ani=0)},this.setStartPos=function(e,t,i){this.startX=e,this.startY=t,this.startDir=i},this.setPos=function(e,t,i){this.x=e,this.y=t,this.d=i},this.reset=function(){this.setPos(this.startX,this.startY,this.startDir)},this.moveUp=function(){m(A.Up)&&(this.y-=1,P+=1),this.d=A.Up,this.animate()},this.moveDown=function(){m(A.Down)&&(this.y+=1,P+=1),this.d=A.Down,this.animate()},this.moveLeft=function(){m(A.Left)&&(this.x-=1,P+=1),this.d=A.Left,this.animate()},this.moveRight=function(){m(A.Right)&&(this.x+=1,P+=1),this.d=A.Right,this.animate()}}function t(e,t,i,a,r,n,l){this.playerPrevX=e,this.playerPrevY=t,this.playerPrevDir=i,this.crateMoved=a,this.crateMoved&&(this.crateX=r,this.crateY=n,this.cratePushDir=l)}function a(e,i,a,r,n,l,s){T.length===U&&T.shift(),T.push(new t(e,i,a,r,n,l,s))}function r(){if(T.length>0){var e=T.pop();if(B.setPos(e.playerPrevX,e.playerPrevY,e.playerPrevDir),e.crateMoved)switch(e.cratePushDir){case A.Up:S[e.crateY][e.crateX]=M.Empty,S[e.crateY+1][e.crateX]=M.Crate;break;case A.Left:S[e.crateY][e.crateX]=M.Empty,S[e.crateY][e.crateX+1]=M.Crate;break;case A.Right:S[e.crateY][e.crateX]=M.Empty,S[e.crateY][e.crateX-1]=M.Crate;break;case A.Down:S[e.crateY][e.crateX]=M.Empty,S[e.crateY-1][e.crateX]=M.Crate}d()}else console.log("No more moves to undo!")}function n(e){this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.canvas.width=32,this.canvas.height=32,this.ctx.drawImage(e,0,0,32,32)}function l(e,t,i,a,r){this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.canvas.width=32,this.canvas.height=32,this.ctx.drawImage(e,t,i,a,r,0,0,32,32)}function s(){I=new Image,I.src="./sokoban/assets/img/my_sprites_charset.png",I.onload=function(){for(b.drawImage(I,0,0),i=0;i<4;i++)for(C[i]=new Array,j=0;j<4;j++)C[i].push(new l(I,32*j,32*i,32,32));v()}}function o(e){Y=e,s()}function h(e,t,i,a,r){for(yDif=-1;yDif<=1;yDif++)for(xDif=-1;xDif<=1;xDif++)if((0!==yDif||0!==xDif)&&(newX=t+xDif,newY=i+yDif,newX>=0&&newX<=a&&newY>=0&&newY<=r&&e[newY][newX]!=M.Wall&&e[newY][newX]!=M.None))return!1;return!0}function c(e){for(xMax=level[O].levelWidth-1,yMax=level[O].levelHeight-1,xMin=0,yMin=0,i=0;i<=yMax;i++)for(j=0;j<=xMax;j++)h(e,j,i,xMax,yMax)&&(e[i][j]=M.None)}function v(){for(S=new Array,i=0;i<level[O].levelHeight;i++)for(S[i]=new Array,j=0;j<level[O].levelWidth;j++)switch(level[O].levelMapOrig[i][j]){case 1:S[i][j]=M.Wall;break;case 2:S[i][j]=M.Crate;break;case 3:S[i][j]=M.Empty;break;case 4:S[i][j]=M.Empty;break;default:S[i][j]=M.Empty}B.setStartPos(level[O].playerStartX,level[O].playerStartY,level[O].playerStartDir),B.reset(),X=0,P=0,W=0,T.length=0,x(),L(),c(S),d()}function y(){O<level.length-1&&(O+=1,f(),v(),d())}function f(){var e=document.getElementById("myDrawing"),t=e.getContext("2d");t.clearRect(0,0,e.width,e.height)}function g(){for(X=0,i=0;i<level[O].levelHeight;i++)for(j=0;j<level[O].levelWidth;j++)S[i][j]===M.Crate&&level[O].levelMapOrig[i][j]===M.Slot&&(X+=1);X===level[O].cratesToPlace&&(O+1<level.length?y():console.log("VIDEO SUIVANTE"))}function d(){for(i=0;i<level[O].levelHeight;i++)for(j=0;j<level[O].levelWidth;j++)w(j,i);b.drawImage(C[playerDirOffset[B.d]][B.ani].canvas,B.x*H,B.y*R)}function p(){switch(B.d){case A.Up:w(B.x,B.y-1),w(B.x,B.y+1);break;case A.Left:w(B.x+1,B.y),w(B.x-1,B.y);break;case A.Right:w(B.x+1,B.y),w(B.x-1,B.y);break;case A.Down:w(B.x,B.y-1),w(B.x,B.y+1)}w(B.x,B.y),b.drawImage(C[playerDirOffset[B.d]][B.ani].canvas,B.x*H,B.y*R)}function w(e,t){switch(S[t][e]){case M.None:D(e*H,t*R,H,R,"#00FF00");break;case M.Wall:b.drawImage(Y[M.Wall].canvas,e*H,t*R);break;case M.Crate:b.drawImage(Y[M.Crate].canvas,e*H,t*R);break;default:b.drawImage(Y[M.Empty].canvas,e*H,t*R),level[O].levelMapOrig[t][e]===M.Slot&&u(e*H+16,t*R+16,7,"#FF0000"),level[O].levelMapOrig[t][e]===M.Start&&u(e*H+16,t*R+16,7,"#00FF00")}}function m(e){var t=0,i=0;switch(e){case A.Up:i=-1;break;case A.Left:t=-1;break;case A.Right:t=1;break;case A.Down:i=1}if(S[B.y+i][B.x+t]!=M.Wall){if(S[B.y+i][B.x+t]!==M.Crate)return a(B.x,B.y,B.d,!1,0,0,0),!0;if(S[B.y+2*i][B.x+2*t]===M.Empty)return S[B.y+i][B.x+t]=M.Empty,S[B.y+2*i][B.x+2*t]=M.Crate,a(B.x,B.y,B.d,!0,B.x+2*t,B.y+2*i,e),W+=1,!0}return!1}function u(e,t,i,a){b.fillStyle=a,b.beginPath(),b.arc(e,t,i,0,2*Math.PI,!0),b.closePath(),b.fill()}function D(e,t,i,a,r){b.fillStyle=r,b.fillRect(e,t,i,a)}function x(){var e=document.getElementById("levelInfo");e.innerHTML="Level: "+(O+1),e=document.getElementById("stepsInfo"),e.innerHTML="Moves: "+P,e=document.getElementById("pushesInfo"),e.innerHTML="Pushes: "+W,e=document.getElementById("cratesInfo"),e.innerHTML="Crates in place: "+X+" / "+level[O].cratesToPlace}function L(){k.width=level[O].levelWidth*H,k.height=level[O].levelHeight*R;var e=document.getElementById("help");e.style.top=k.offsetTop+10+"px",e.style.left=k.offsetLeft+10+"px",e.style.width=k.width-30+"px",e.style.height=k.height-30+"px"}var k,b,A={Up:0,Left:1,Right:2,Down:3},M={None:-1,Empty:0,Wall:1,Crate:2,Slot:3,Start:4};k=document.getElementById("myDrawing"),b=k.getContext("2d");var E={imgArray:[],toLoad:0,tileArray:[],callback:0,init:function(e,t){this.imgArray=e,this.toLoad=this.imgArray.length,this.callback=t;for(i in this.imgArray)this.tileArray[i]=0},startLoading:function(){for(i in this.imgArray)img=new Image,img.src=this.imgArray[i],img.imgIndex=i,img.onload=function(){E.finishedLoading(this)}},finishedLoading:function(e){this.toLoad-=1,this.tileArray[e.imgIndex]=new n(e),this.toLoad<=0&&this.callback(this.tileArray)}};E.init(new Array("./sokoban/assets/img/textures/ground.png","./sokoban/assets/img/textures/wall.png","./sokoban/assets/img/textures/stone.png"),o),E.startLoading();var I;playerDirOffset=new Array(3,1,2,0),playerAniOffset=new Array(0,1,2,3);var S,X,Y=new Array,C=new Array,O=0,P=0,W=0,H=32,R=32,T=new Array,U=500,B=new e;document.onkeydown=function(e){var t=e;switch(t.keyCode){case 38:B.moveUp();break;case 37:B.moveLeft();break;case 39:B.moveRight();break;case 40:B.moveDown();break;case 0:114===t.charCode?v():117===t.charCode&&r()}p(),g(),x()},$(function(){$("#arrow-top").on("click",function(){var e=$.Event("keydown",{keyCode:38});$("body").trigger(e)}),$("#arrow-bottom").on("click",function(){var e=$.Event("keydown",{keyCode:40});$("body").trigger(e)}),$("#arrow-left").on("click",function(){var e=$.Event("keydown",{keyCode:37});$("body").trigger(e)}),$("#arrow-right").on("click",function(){var e=$.Event("keydown",{keyCode:39});$("body").trigger(e)})})};